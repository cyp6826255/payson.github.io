<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI" />
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="description" content="与你一起发现更大的世界。">
    <meta name="keywords"  content="PaysonChen,iOS,流媒体">
    <meta name="theme-color" content="#000000">
    
    <!-- Open Graph -->
    <meta property="og:title" content="iOS话外篇：构建详解 - PaysonChen的博客 | PaysonChen Blog">
    
    <meta property="og:type" content="article">
    <meta property="og:description" content="iOS话外篇：构建详解
">
    
    
    <meta property="article:published_time" content="2023-08-08T00:00:00Z">
    
    
    <meta property="article:author" content="PaysonChen">
    
    
    
    <meta property="og:image" content="http://localhost:4000">
    <meta property="og:url" content="http://localhost:4000/2023/08/08/iOS-%E8%AF%9D%E5%A4%96%E7%AF%87-%E6%9E%84%E5%BB%BA%E8%AF%A6%E8%A7%A3/">
    <meta property="og:site_name" content="PaysonChen的博客 | PaysonChen Blog">
    
    <title>iOS话外篇：构建详解 - PaysonChen的博客 | PaysonChen Blog</title>

    <!-- Web App Manifest -->
    <link rel="manifest" href="/pwa/manifest.json">

    <!-- Favicon -->
    <link rel="shortcut icon" href="/img/favicon.ico">
    
    <!-- Canonical URL -->
    <link rel="canonical" href="http://localhost:4000/2023/08/08/iOS-%E8%AF%9D%E5%A4%96%E7%AF%87-%E6%9E%84%E5%BB%BA%E8%AF%A6%E8%A7%A3/">

    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css">

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/hux-blog.min.css">

    <!-- Custom Fonts -->
    <!-- <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
    <!-- Hux change font-awesome CDN to qiniu -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" type="text/css">


    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

    <!-- ga & ba script hoook -->
    <script></script>
</head>


<!-- hack iOS CSS :active style -->
<body ontouchstart="">

    <!-- Navigation -->

    <nav class="navbar navbar-default navbar-custom navbar-fixed-top">
        
        <div class="container-fluid">
            <!-- Brand and toggle get grouped for better mobile display -->
            <div class="navbar-header page-scroll">
                <button type="button" class="navbar-toggle">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
                <a class="navbar-brand" href="/">PaysonChen Blog</a>
            </div>

            <!-- Collect the nav links, forms, and other content for toggling -->
            <div id="huxblog_navbar">
                <div class="navbar-collapse">
                    <ul class="nav navbar-nav navbar-right">
                        <li>
                            <a href="/">Home</a>
                        </li>
                        
                        
                        
                        
                        <li>
                            <a href="/about/">About</a>
                        </li>
                        
                        
                        
                        <li>
                            <a href="/archive/">Archive</a>
                        </li>
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        
                        <li class="search-icon">
                            <a href="javascript:void(0)">
                                <i class="fa fa-search"></i>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
            <!-- /.navbar-collapse -->
        </div>
        <!-- /.container -->
    </nav>

    <script>
        // Drop Bootstarp low-performance Navbar
        // Use customize navbar with high-quality material design animation
        // in high-perf jank-free CSS3 implementation
        var $body = document.body;
        var $toggle = document.querySelector('.navbar-toggle');
        var $navbar = document.querySelector('#huxblog_navbar');
        var $collapse = document.querySelector('.navbar-collapse');

        var __HuxNav__ = {
            close: function () {
                $navbar.className = " ";
                // wait until animation end.
                setTimeout(function () {
                    // prevent frequently toggle
                    if ($navbar.className.indexOf('in') < 0) {
                        $collapse.style.height = "0px"
                    }
                }, 400)
            },
            open: function () {
                $collapse.style.height = "auto"
                $navbar.className += " in";
            }
        }

        // Bind Event
        $toggle.addEventListener('click', function (e) {
            if ($navbar.className.indexOf('in') > 0) {
                __HuxNav__.close()
            } else {
                __HuxNav__.open()
            }
        })

        /**
         * Since Fastclick is used to delegate 'touchstart' globally
         * to hack 300ms delay in iOS by performing a fake 'click',
         * Using 'e.stopPropagation' to stop 'touchstart' event from 
         * $toggle/$collapse will break global delegation.
         * 
         * Instead, we use a 'e.target' filter to prevent handler
         * added to document close HuxNav.  
         *
         * Also, we use 'click' instead of 'touchstart' as compromise
         */
        document.addEventListener('click', function (e) {
            if (e.target == $toggle) return;
            if (e.target.className == 'icon-bar') return;
            __HuxNav__.close();
        })
    </script>
    <!-- Search -->
<div class="search-page">
  <div class="search-icon-close-container">
    <span class="search-icon-close">
      <i class="fa fa-chevron-down"></i>
    </span>
  </div>
  <div class="search-main container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <form></form>
        <input type="text" id="search-input" placeholder="$ grep...">
        </form>
        <div id="search-results" class="mini-post-list"></div>
      </div>
    </div>
  </div>
</div>

    <!-- Image to hack wechat -->
<!-- <img src="/img/icon_wechat.png" width="0" height="0"> -->
<!-- <img src="/img/home-bg-geek.jpg" width="0" height="0"> -->

<!-- Post Header -->



<style type="text/css">
    header.intro-header{
        position: relative;
        background-image: url('/img/home-bg-geek.jpg');
        background: ;
    }

    
</style>

<header class="intro-header" >

    <div class="header-mask"></div>
    
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <div class="post-heading">
                    <div class="tags">
                        
                    </div>
                    <h1>iOS话外篇：构建详解</h1>
                    
                    <h2 class="subheading"></h2>
                    <span class="meta">Posted by PaysonChen on August 8, 2023</span>
                </div>
            </div>
        </div>
    </div>
</header>






<!-- Post Content -->
<article>
    <div class="container">
        <div class="row">

    <!-- Post Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                post-container">

                <!-- Multi-Lingual -->
                

				<h1 id="ios话外篇构建详解">iOS话外篇：构建详解</h1>

<h2 id="1背景">1.背景</h2>

<p>想必大多数iOS开发者不陌生，通过xcode 自带的 archive 打包，习惯GUI的同学，可能更倾向于archive打包，虽然archive打包有很多优点：包括可视化、学习门槛低、报错清晰等，但是在团队协作与日常构建中，他的弊端就显现出来了：</p>

<ul>
  <li>步骤多</li>
</ul>

<p>​		打包前需要同步代码、打包过程中需要选择签名、打包后要归档、并选择上传包的地方（分发渠道orAppStore）</p>

<ul>
  <li>时间长</li>
</ul>

<p>​		构建时间随着工程迭代越来越漫长，大型全量打包可能到数十分钟，archive会阻断当前研发进程，无法利用本机算力之外的其他计算集群资源，影响研效</p>

<ul>
  <li>灵活不佳</li>
</ul>

<p>​		构建过程中可能需要对版本的build号进行自增、归档dsym文件、构建通知等，采用archive这些都可能需要手动执行</p>

<ul>
  <li>可靠性不佳</li>
</ul>

<p>​		对于分支、代码、签名、构建方式等匹配均需靠人工维护，流程步骤多，容易造成错误，不可靠</p>

<h2 id="2构建设计">2.构建设计</h2>

<p>为了设计一个通用的构建脚本，需要将核心构建流程分层与归类，设计入参、使用构建环境等。程序入口如下：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre></td><td class="rouge-code"><pre><span class="c">#通过外部传参 读取自定义参数 2:target_name</span>
<span class="c"># 2 必须</span>
coustomSettings <span class="nv">$2</span>

<span class="c"># 3 (可选) 蒲公英渠道号，拼接url</span>
publishSettings <span class="nv">$3</span>

<span class="c"># 4 (可选)是否静默通知，有值 则不发通知</span>
notificationSettings <span class="nv">$4</span>

<span class="c">#开始构建 1:configuration(0:DailyBuild|1:TestFlight|2:Release|3:TFInner)</span>
<span class="c">#1 必须</span>
build <span class="nv">$1</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="21入参设计">2.1入参设计：</h3>

<h4 id="211参数1构建方式">2.1.1参数1：构建方式</h4>

<table>
  <tbody>
    <tr>
      <td>对应工程中的Configuration ，枚举值：0:DailyBuild</td>
      <td>1:TestFlight</td>
      <td>2:Release</td>
      <td>3:TFInner</td>
    </tr>
  </tbody>
</table>

<ul>
  <li>
    <p>DailyBuild：用于日常构建，CI/CD</p>
  </li>
  <li>
    <p>TestFlight：用于打灰度包</p>
  </li>
  <li>
    <p>Release：用于打生产包</p>
  </li>
  <li>
    <p>TFInner：用于打内部TF包</p>

    <p>特别说明：由于，Apple的Enterprise证书($299/年)账号申请条件苛刻，通过此方案可以临时解决100台测试设备不足的问题</p>
  </li>
</ul>

<h4 id="212-参数2target名称">2.1.2 参数2：Target名称</h4>

<p>工程的TargetName：</p>

<p><img src="/img/ios-build/iOS_Build1.png" alt="iOS_Build1" /></p>

<p><a name="2.1.3"></a></p>

<h4 id="213-参数3可选渠道号">2.1.3 参数3(可选)：渠道号</h4>

<p>​	在没有使用支持iOS app分发的流水线（类似于腾讯蓝鲸（蓝盾流水线））情况下：本文例子使用蒲公英进行应用分发，为了兼容多渠道并行，用于拼接分发下载地址的url。</p>

<p><img src="/img/ios-build/iOS_Build2.png" alt="iOS_Build2" /></p>

<h5 id="2131-第三方分发蒲公英">2.1.3.1 第三方分发：蒲公英</h5>

<p>​	流水线通过API进行应用分发，下面说明，渠道号为空与非空的情况：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre>  <span class="c">#其他构建包上传到pgy</span>
        <span class="nb">echo</span> <span class="s1">'/// 上传 PGY 开始 IPA_PATH='</span><span class="k">${</span><span class="nv">IPA_PATH</span><span class="k">}</span>
        <span class="nb">echo</span> <span class="s1">'/// 上传 PGY 开始 渠道='</span><span class="k">${</span><span class="nv">pgyChannel</span><span class="k">}</span>
        <span class="nv">compileEnvironment</span><span class="o">=</span><span class="s2">"</span><span class="k">${</span><span class="nv">buildName</span><span class="k">}</span><span class="s2">:</span><span class="k">${</span><span class="nv">git_log</span><span class="k">}</span><span class="s2">"</span>
        
        <span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$pgyChannel</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
            <span class="c"># 渠道空，则走默认 不指定渠道号的上传</span>
            curl <span class="nt">-F</span> <span class="s1">'file=@'</span><span class="k">${</span><span class="nv">IPA_PATH</span><span class="k">}</span> <span class="nt">-F</span> <span class="s1">'_api_key='</span><span class="k">${</span><span class="nv">pgyAPIKey</span><span class="k">}</span> <span class="nt">-F</span> <span class="s1">'buildUpdateDescription='</span><span class="k">${</span><span class="nv">compileEnvironment</span><span class="k">}</span> https://www.pgyer.com/apiv2/app/upload
        <span class="k">else</span>
            <span class="c"># 渠道非空，走下载地址关联 渠道</span>
            curl <span class="nt">-F</span> <span class="s1">'file=@'</span><span class="k">${</span><span class="nv">IPA_PATH</span><span class="k">}</span> <span class="nt">-F</span> <span class="s1">'_api_key='</span><span class="k">${</span><span class="nv">pgyAPIKey</span><span class="k">}</span> <span class="nt">-F</span> <span class="s1">'buildUpdateDescription='</span><span class="k">${</span><span class="nv">compileEnvironment</span><span class="k">}</span>  <span class="nt">-F</span> <span class="s1">'buildChannelShortcut='</span><span class="k">${</span><span class="nv">pgyDownloadUrlSubfix</span><span class="k">}</span> https://www.pgyer.com/apiv2/app/upload
        <span class="k">fi
                
        </span><span class="nb">echo</span> <span class="s1">'/// 上传 PGY 结束'</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h5 id="2132-扩展阿里云oss云存储分发">2.1.3.2 扩展：阿里云OSS云存储分发</h5>

<p>基于蒲公英的分发受限于蒲公英上行带宽与收费阈值，探索一种容灾分发方式，避免蒲公英未来服务出现异常时的健壮性。</p>

<p>自行分发需要用Ad-Hoc方式，遵循Apple协议：itms-services://?action=download-manifest&amp;url=</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
</pre></td><td class="rouge-code"><pre><span class="c">#添加commit信息到二维码图片上</span>
<span class="k">function </span>add_log_commit_title_msg_to_qrcode <span class="o">()</span>
<span class="o">{</span>
    <span class="c">#二维码打上版本信息</span>
    <span class="c">#TODO: 这里需要安装下工具 ImageMgick [brew install ImageMgick]</span>
    <span class="nv">title</span><span class="o">=</span><span class="nv">$xcodeVersion3number</span>.<span class="k">${</span><span class="nv">channel_name</span><span class="k">}</span>.<span class="nv">$configurationName</span>.<span class="k">${</span><span class="nv">BuildNo</span><span class="k">}</span>

    <span class="k">if</span> <span class="o">[</span> <span class="nv">$1</span> <span class="o">=</span> <span class="s2">"1"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nv">dst_line_cnt</span><span class="o">=</span>0
        <span class="nb">export </span><span class="nv">oss_source_log_arr</span><span class="o">=(</span><span class="sb">`</span><span class="nb">echo</span> <span class="nv">$source_log_str</span> | <span class="nb">tr</span> <span class="s1">']['</span> <span class="s1">' '</span><span class="sb">`</span><span class="o">)</span>
        <span class="nb">export </span><span class="nv">oss_log_line_count</span><span class="o">=</span><span class="k">${#</span><span class="nv">oss_source_log_arr</span><span class="p">[@]</span><span class="k">}</span>
        <span class="nb">echo</span> <span class="s1">'/// oss 分发： 添加 二维码msg log_line_count='</span><span class="nv">$oss_log_line_count</span>

        <span class="k">for</span><span class="o">((</span> <span class="nv">i</span><span class="o">=</span>0<span class="p">;</span>i&lt;<span class="k">${</span><span class="nv">oss_log_line_count</span><span class="k">}</span><span class="p">;</span>i++<span class="o">))</span>
        <span class="k">do
            </span><span class="nv">single_len</span><span class="o">=</span><span class="si">$(</span><span class="nb">echo</span> <span class="nt">-n</span> <span class="s2">"</span><span class="k">${</span><span class="nv">oss_source_log_arr</span><span class="p">[i]</span><span class="k">}</span><span class="s2">"</span> | <span class="nb">wc</span> <span class="nt">-m</span><span class="si">)</span>
            <span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="k">${</span><span class="nv">oss_source_log_arr</span><span class="p">[i]</span><span class="k">}</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
                </span><span class="nv">oss_singleStr</span><span class="o">=</span><span class="k">${</span><span class="nv">oss_source_log_arr</span><span class="p">[i]</span><span class="k">}</span><span class="p">;</span>
                <span class="nb">echo</span> <span class="s1">'///--遍历'</span><span class="k">${</span><span class="nv">oss_source_log_arr</span><span class="p">[i]</span><span class="k">}</span><span class="s1">'为空文字长度：'</span><span class="nv">$single_len</span>
                <span class="nv">dst_line_cnt</span><span class="o">=</span><span class="k">$((</span>dst_line_cnt+1<span class="k">))</span>
            <span class="k">else
                </span><span class="nv">line_max_len</span><span class="o">=</span>30
                <span class="nv">ingle_cnt</span><span class="o">=</span><span class="k">$((</span>single_len <span class="o">/</span> line_max_len<span class="k">))</span>


                <span class="k">if</span> <span class="o">((</span>ingle_cnt <span class="o">&gt;</span> 0<span class="o">))</span><span class="p">;</span> <span class="k">then
                    for</span><span class="o">((</span> <span class="nv">j</span><span class="o">=</span>0<span class="p">;</span>j&lt;<span class="o">=</span><span class="k">${</span><span class="nv">ingle_cnt</span><span class="k">}</span><span class="p">;</span>j++<span class="o">))</span>
                    <span class="k">do
                        </span><span class="nv">string</span><span class="o">=</span><span class="k">${</span><span class="nv">oss_source_log_arr</span><span class="p">[i]</span><span class="k">}</span>
                        <span class="nv">single_line1</span><span class="o">=</span><span class="k">${</span><span class="nv">string</span>:<span class="p">(line_max_len * j)</span>:line_max_len<span class="k">}</span>
                        <span class="nb">echo</span> <span class="s1">'///--遍历'</span> <span class="k">${</span><span class="nv">oss_source_log_arr</span><span class="p">[i]</span><span class="k">}</span><span class="s1">'文字长度：'</span><span class="nv">$single_len</span><span class="s1">'超阈值阶段：第'</span><span class="nv">$j</span><span class="s1">'行:'</span><span class="nv">$single_line1</span>
                        oss_singleStr+<span class="o">=</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="k">${</span><span class="nv">single_line1</span><span class="k">}</span><span class="p">;</span>
                        <span class="nv">dst_line_cnt</span><span class="o">=</span><span class="k">$((</span>dst_line_cnt+1<span class="k">))</span>
                    <span class="k">done</span><span class="p">;</span>
                <span class="k">else
                    </span><span class="nb">echo</span> <span class="s1">'///--遍历'</span> <span class="k">${</span><span class="nv">oss_source_log_arr</span><span class="p">[i]</span><span class="k">}</span><span class="s1">' 文字长度：'</span><span class="nv">$single_len</span>
                    <span class="nv">dst_line_cnt</span><span class="o">=</span><span class="k">$((</span>dst_line_cnt+1<span class="k">))</span>
                    oss_singleStr+<span class="o">=</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="k">${</span><span class="nv">oss_source_log_arr</span><span class="p">[i]</span><span class="k">}</span><span class="p">;</span>
                <span class="k">fi
            fi
        done</span><span class="p">;</span>
        <span class="nv">msg</span><span class="o">=</span><span class="nv">$oss_singleStr</span>
        <span class="nb">echo</span> <span class="s2">"/// oss render msg="</span><span class="nv">$msg</span>
        
        <span class="nv">contentsize_width</span><span class="o">=</span>600
        <span class="nv">contentsize_height</span><span class="o">=</span><span class="k">$((</span>contentsize_width <span class="o">+</span> <span class="nv">$dst_line_cnt</span> <span class="o">*</span> <span class="m">25</span> <span class="o">+</span> <span class="m">40</span> <span class="o">+</span> <span class="m">40</span><span class="k">))</span> <span class="c">#第一个40是title的高度 第二个40是距离底部空间</span>
        <span class="nb">echo</span> <span class="s2">"contentsize_height="</span><span class="nv">$contentsize_height</span>
        <span class="c">#改变原图大小</span>
        convert <span class="nv">$qrcode_path</span> <span class="nt">-resize</span> <span class="k">${</span><span class="nv">contentsize_width</span><span class="k">}</span>x<span class="k">${</span><span class="nv">contentsize_width</span><span class="k">}</span>^ <span class="nt">-gravity</span> center <span class="k">${</span><span class="nv">qrcode_path</span><span class="k">}</span>_1.png

        <span class="c">#变高，兼容msg</span>
        convert <span class="k">${</span><span class="nv">qrcode_path</span><span class="k">}</span>_1.png <span class="nt">-gravity</span> north <span class="nt">-extent</span> <span class="k">${</span><span class="nv">contentsize_width</span><span class="k">}</span>x<span class="k">${</span><span class="nv">contentsize_height</span><span class="k">}</span> <span class="k">${</span><span class="nv">qrcode_path</span><span class="k">}</span>_2.png

        <span class="c">#汉字字体</span>
        <span class="nv">chn_tff_path</span><span class="o">=</span><span class="nv">$build_ext_path</span>/publish_res/chn.ttf
        
        <span class="c">#渲染title</span>
        convert <span class="k">${</span><span class="nv">qrcode_path</span><span class="k">}</span>_2.png <span class="nt">-gravity</span> north <span class="nt">-pointsize</span> 30 <span class="nt">-font</span> <span class="nv">$chn_tff_path</span> <span class="nt">-fill</span> black <span class="nt">-annotate</span> +0+<span class="k">${</span><span class="nv">contentsize_width</span><span class="k">}</span> <span class="nv">$title</span> <span class="k">${</span><span class="nv">qrcode_path</span><span class="k">}</span>_3.png

        <span class="c">#渲染msg</span>
        convert <span class="k">${</span><span class="nv">qrcode_path</span><span class="k">}</span>_3.png <span class="nt">-gravity</span> north <span class="nt">-pointsize</span> 20 <span class="nt">-font</span> <span class="nv">$chn_tff_path</span> <span class="nt">-fill</span> black <span class="nt">-annotate</span> +0+<span class="k">$((${</span><span class="nv">contentsize_width</span><span class="k">}</span><span class="o">+</span><span class="m">40</span><span class="k">))</span> <span class="nv">$msg</span> <span class="k">${</span><span class="nv">qrcode_path</span><span class="k">}</span>_4.png
        <span class="nv">qrcode_path_with_msg</span><span class="o">=</span><span class="k">${</span><span class="nv">qrcode_path</span><span class="k">}</span>_4.png
    <span class="k">else</span>
        <span class="c">#没有传 1 不需要msg，只给title</span>
        convert <span class="nv">$qrcode_path</span> <span class="nt">-gravity</span> south <span class="nt">-pointsize</span> 10 <span class="nt">-fill</span> gray <span class="nt">-annotate</span> +0+0 <span class="nv">$qrcode_print_msg</span>  <span class="nv">$qrcode_path_with_msg</span>
        <span class="nb">echo</span> <span class="s1">'/// oss 分发： 添加 二维码title='</span><span class="k">${</span><span class="nv">title</span><span class="k">}</span>
    <span class="k">fi</span>

<span class="o">}</span>

<span class="c">#发布到阿里云OSS</span>
<span class="k">function </span>upload_ipa_to_aliyunOSS <span class="o">()</span>
<span class="o">{</span>
    <span class="c">#更新plist的键值对：</span>
    <span class="nv">manifest_path</span><span class="o">=</span><span class="k">${</span><span class="nv">exportPath</span><span class="k">}</span>/manifest.plist
    <span class="nb">echo</span> <span class="s1">'/// oss 分发： manifest_path='</span><span class="k">${</span><span class="nv">manifest_path</span><span class="k">}</span>
    
    <span class="nv">oss_bucket</span><span class="o">=</span><span class="s2">"cbs-apps-test"</span>
    <span class="nv">oss_platform</span><span class="o">=</span><span class="s2">"iOS"</span>
    <span class="nv">oss_bucket_path</span><span class="o">=</span><span class="nv">$oss_platform</span>/<span class="k">${</span><span class="nv">TARGET_NAME</span><span class="k">}</span>/<span class="nv">$configurationName</span>/<span class="k">${</span><span class="nv">channel_name</span><span class="k">}</span>/<span class="k">${</span><span class="nv">BuildNo</span><span class="k">}</span>/<span class="k">${</span><span class="nv">TARGET_NAME</span><span class="k">}</span>_<span class="k">${</span><span class="nv">channel_name</span><span class="k">}</span>_<span class="nv">$configurationName_</span><span class="k">${</span><span class="nv">BuildNo</span><span class="k">}</span>
    <span class="nv">oss_path</span><span class="o">=</span><span class="s2">"oss://</span><span class="nv">$oss_bucket</span><span class="s2">/</span><span class="nv">$oss_bucket_path</span><span class="s2">"</span>
    <span class="nv">oss_url</span><span class="o">=</span><span class="s2">"https://</span><span class="nv">$oss_bucket</span><span class="s2">.oss-cn-beijing.aliyuncs.com/</span><span class="nv">$oss_bucket_path</span><span class="s2">"</span>

    <span class="nv">oss_ipa_upload_url</span><span class="o">=</span><span class="nv">$oss_path</span><span class="s2">".ipa"</span>
    <span class="nv">oss_ipa_url</span><span class="o">=</span><span class="nv">$oss_url</span><span class="s2">".ipa"</span>

    <span class="c">#icon下载地址配置</span>
    <span class="nv">oss_icon_url</span><span class="o">=</span><span class="s2">"https://cbs-apps-test.oss-cn-beijing.aliyuncs.com/iOS/</span><span class="k">${</span><span class="nv">TARGET_NAME</span><span class="k">}</span><span class="s2">/icon/icon.png"</span>
    <span class="nv">oss_icon_fs_url</span><span class="o">=</span><span class="s2">"https://cbs-apps-test.oss-cn-beijing.aliyuncs.com/iOS/</span><span class="k">${</span><span class="nv">TARGET_NAME</span><span class="k">}</span><span class="s2">/icon/icon_fs.png"</span>

    
    <span class="c">#修改ipa下载地址</span>
    /usr/libexec/PlistBuddy <span class="nt">-c</span> <span class="s2">"Set :items:0:assets:0:url </span><span class="nv">$oss_ipa_url</span><span class="s2">"</span> <span class="nv">$manifest_path</span>

    <span class="c">#修改icon地址</span>
    /usr/libexec/PlistBuddy <span class="nt">-c</span> <span class="s2">"Set :items:0:assets:1:url </span><span class="nv">$oss_icon_url</span><span class="s2">"</span> <span class="nv">$manifest_path</span>

    <span class="c">#修改icon full size地址</span>
    /usr/libexec/PlistBuddy <span class="nt">-c</span> <span class="s2">"Set :items:0:assets:2:url </span><span class="nv">$oss_icon_fs_url</span><span class="s2">"</span> <span class="nv">$manifest_path</span>


    <span class="c">#传ipa</span>
    ossutil <span class="nb">cp</span> <span class="k">${</span><span class="nv">IPA_PATH</span><span class="k">}</span> <span class="nv">$oss_ipa_upload_url</span> <span class="nt">-f</span>
    
    <span class="c">#传manifest</span>
    <span class="nv">oss_manifest_extension</span><span class="o">=</span><span class="s2">"plist"</span>
    <span class="nv">oss_manifest_upload_url</span><span class="o">=</span><span class="nv">$oss_path</span><span class="s2">"."</span><span class="nv">$oss_manifest_extension</span>
    <span class="nv">oss_manifest_url</span><span class="o">=</span><span class="nv">$oss_url</span><span class="s2">"."</span><span class="nv">$oss_manifest_extension</span>
    ossutil <span class="nb">cp</span> <span class="k">${</span><span class="nv">manifest_path</span><span class="k">}</span> <span class="nv">$oss_manifest_upload_url</span> <span class="nt">-f</span>
    
    <span class="c">#上述做归档后，生成下载二维码</span>
    <span class="nv">download_url</span><span class="o">=</span><span class="s2">"itms-services://?action=download-manifest&amp;url="</span><span class="nv">$oss_manifest_url</span>
    <span class="nv">qrcode_path</span><span class="o">=</span><span class="k">${</span><span class="nv">exportPath</span><span class="k">}</span>/<span class="k">${</span><span class="nv">TARGET_NAME</span><span class="k">}</span>_<span class="k">${</span><span class="nv">BuildNo</span><span class="k">}</span>.png
    
    <span class="c">#TODO: 这里需要安装下工具 qrencode [brew install qrencode]</span>
    qrencode <span class="nt">-o</span> <span class="nv">$qrcode_path</span> <span class="nv">$download_url</span>
    
    <span class="c">#将二维码上传到oss</span>
    <span class="nv">oss_qrencode_extension</span><span class="o">=</span><span class="s2">"png"</span>
    <span class="nv">oss_qrencode_upload_url</span><span class="o">=</span><span class="nv">$oss_path</span><span class="s2">"."</span><span class="nv">$oss_qrencode_extension</span>
    <span class="nv">qrcode_path_with_msg</span><span class="o">=</span><span class="k">${</span><span class="nv">qrcode_path</span><span class="k">}</span>_with_msg
        
    <span class="c">#如果需要二维码打上log信息则调用</span>
    <span class="nv">need_msg</span><span class="o">=</span>1
    add_log_commit_title_msg_to_qrcode <span class="nv">$need_msg</span>
        
    <span class="c">#上传到阿里云oss</span>
    ossutil <span class="nb">cp</span> <span class="k">${</span><span class="nv">qrcode_path_with_msg</span><span class="k">}</span> <span class="nv">$oss_qrencode_upload_url</span> <span class="nt">-f</span>
    
    <span class="c">#二维码的url 通知出来</span>
    <span class="nb">export </span><span class="nv">oss_app_download_qrcode_url</span><span class="o">=</span><span class="nv">$oss_url</span><span class="s2">"."</span><span class="nv">$oss_qrencode_extension</span>
    <span class="nb">echo</span> <span class="s1">'/// oss 分发： 二维码的oss_app_download_qrcode_url='</span><span class="k">${</span><span class="nv">oss_app_download_qrcode_url</span><span class="k">}</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p><a name="2.1.4"></a></p>

<h4 id="214-参数4可选是否静默通知">2.1.4 参数4(可选)：是否静默通知</h4>

<p>​	本文例子通过钉钉API发送通知到钉钉群，默认不填发送，有值则不发通知，通知内容整合双分发方案：</p>

<p>​	下面代码为发送通知的逻辑，请将相应的变量替换成自己的参数</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
</pre></td><td class="rouge-code"><pre>    <span class="nv">modify_msg</span><span class="o">=</span><span class="k">${</span><span class="nv">git_log</span><span class="k">}</span>
    <span class="nv">ProductName</span><span class="o">=</span><span class="k">${</span><span class="nv">xcodeProductName</span><span class="k">}</span>
    <span class="nv">downloadPrefix</span><span class="o">=</span><span class="k">${</span><span class="nv">PrefixID</span><span class="k">}</span>
    <span class="nv">channel</span><span class="o">=</span><span class="k">${</span><span class="nv">pgyChannel</span><span class="k">}</span>
    <span class="nv">title</span><span class="o">=</span><span class="k">${</span><span class="nv">buildName</span><span class="k">}</span>

    <span class="c">#采用直接 拼 channel后缀</span>
    <span class="nv">shortUrl</span><span class="o">=</span><span class="k">${</span><span class="nv">downloadPrefix</span><span class="k">}${</span><span class="nv">ProductName</span><span class="k">}${</span><span class="nv">channel</span><span class="k">}</span>

    <span class="c">#蒲公英下载地址</span>
    <span class="nv">pgy_app_donwnload_url</span><span class="o">=</span><span class="s2">"https://www.pgyer.com/</span><span class="k">${</span><span class="nv">shortUrl</span><span class="k">}</span><span class="s2">"</span>
    
   <span class="c">#oss下载地址</span>
    <span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$oss_app_download_qrcode_url</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="c">#为空则使用pgy</span>
        <span class="nb">echo</span> <span class="s2">"通知：oss_app_download_qrcode_url 为空则使用pgy：'</span><span class="k">${</span><span class="nv">app_donwnload_url</span><span class="k">}</span><span class="s2">'"</span>
        <span class="nv">app_donwnload_url</span><span class="o">=</span><span class="nv">$pgy_app_donwnload_url</span>
    <span class="k">else</span>
        <span class="c">#不为空使用 pgy + oss</span>
        <span class="nb">echo</span> <span class="s2">"通知：oss_app_download_qrcode_url 不为空使用 pgy + oss则使用pgy + oss：'</span><span class="k">${</span><span class="nv">app_donwnload_url</span><span class="k">}</span><span class="s2">' and '</span><span class="nv">$oss_app_download_qrcode_url</span><span class="s2">'"</span>
        <span class="nv">app_donwnload_url</span><span class="o">=</span><span class="k">${</span><span class="nv">pgy_app_donwnload_url</span><span class="k">}</span><span class="s1">'\n'</span>oss下载地址:<span class="nv">$oss_app_download_qrcode_url</span>
    <span class="k">fi</span>
<span class="c">#    app_donwnload_url=$oss_app_download_qrcode_url</span>
    
    <span class="nb">echo</span> <span class="s2">"通知 COME下载地址：'</span><span class="k">${</span><span class="nv">app_donwnload_url</span><span class="k">}</span><span class="s2">'"</span>

    
    curl <span class="s1">'https://oapi.dingtalk.com/robot/send?access_token='</span><span class="k">${</span><span class="nv">access_token</span><span class="k">}</span> <span class="se">\</span>
        <span class="nt">-H</span> <span class="s1">'Content-Type: application/json'</span> <span class="se">\</span>
        <span class="nt">-d</span> <span class="s1">'{"msgtype": "text",
            "at": {
            "atMobiles":[
                "这"
                "里"
                "是"
                "钉"
                "钉"
                "账"
                "号"
            ],
            "isAtAll": false
            },
             "text": {
                  "content": "'</span><span class="k">${</span><span class="nv">ProductName</span><span class="k">}</span><span class="s1">' App更新：'</span><span class="k">${</span><span class="nv">title</span><span class="k">}</span><span class="s1">'\n'</span><span class="k">${</span><span class="nv">modify_msg</span><span class="k">}</span><span class="s1">'\n下载地址：https://www.pgyer.com/'</span><span class="k">${</span><span class="nv">app_donwnload_url</span><span class="k">}</span><span class="s1">'"            }
           }'</span>
    <span class="nb">echo</span> <span class="s1">'///-------------------------------------------------------'</span>
    <span class="nb">echo</span> <span class="s1">'/// 发送通知 '</span>
    <span class="nb">echo</span> <span class="s1">'///-------------------------------------------------------'</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h3 id="22-流程设计">2.2 流程设计：</h3>

<h4 id="221-构建前">2.2.1 构建前：</h4>

<ul>
  <li>入参设置</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre></td><td class="rouge-code"><pre><span class="c">#入参设置</span>
<span class="k">function </span>coustomSettings<span class="o">()</span>
<span class="o">{</span>
    <span class="c">#需要打包的target</span>
    <span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"error: TARGET_NAME 不能为空 退出"</span>
        <span class="nb">exit </span>1
    <span class="k">else
        </span><span class="nb">export </span><span class="nv">TARGET_NAME</span><span class="o">=</span><span class="nv">$1</span>
    <span class="k">fi</span>

    <span class="c">#工程所在目录，如果在根目录则为${WORKSPACE}</span>
    
    <span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$2</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">export </span><span class="nv">projectDir</span><span class="o">=</span><span class="k">${</span><span class="nv">TARGET_NAME</span><span class="k">}</span>
    <span class="k">else
        </span><span class="nb">export </span><span class="nv">projectDir</span><span class="o">=</span><span class="nv">$2</span>
    <span class="k">fi</span>
<span class="c">#    export projectDir=YPCProject</span>
    <span class="nb">echo</span> <span class="s2">"TARGET_NAME="</span><span class="nv">$TARGET_NAME</span>
    <span class="nb">echo</span> <span class="s2">"projectDir="</span><span class="nv">$projectDir</span>

<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>发布设置：</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre></td><td class="rouge-code"><pre><span class="c">#发布及归档的相关的设置</span>
<span class="k">function </span>publishSettings<span class="o">()</span>
<span class="o">{</span>
    <span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">echo</span> <span class="s1">'///渠道号入参 为空'</span>
        <span class="nb">export </span><span class="nv">pgyChannel</span><span class="o">=</span>Dev
    <span class="k">else
        </span><span class="nb">echo</span> <span class="s1">'///渠道号入参 不为空'</span>
        <span class="nb">export </span><span class="nv">pgyChannel</span><span class="o">=</span><span class="nv">$1</span>
    <span class="k">fi
    
    </span><span class="nb">echo</span> <span class="s2">"////渠道号"</span><span class="k">${</span><span class="nv">pgyChannel</span><span class="k">}</span>
    
    <span class="c">#声明蒲公英分发调用APi的pgyAPIKey</span>
    <span class="nb">export </span><span class="nv">pgyAPIKey</span><span class="o">=</span><span class="s2">"pgyAPIKey"</span>
    
    <span class="c">#钉钉发送通知机器人的access_token</span>
    <span class="nb">export </span><span class="nv">access_token</span><span class="o">=</span><span class="s2">"access_token"</span>

    <span class="c">#AppStore的token</span>
    <span class="nb">export </span><span class="nv">appStore_apiIssuer</span><span class="o">=</span><span class="s2">"appStore_apiIssuer"</span>
    <span class="nb">export </span><span class="nv">appStore_apikey</span><span class="o">=</span><span class="s2">"appStore_apikey"</span>
            
    <span class="c">#bugly的token</span>
    <span class="nb">export </span><span class="nv">bugly_appid</span><span class="o">=</span><span class="s2">"bugly_appid"</span>
    <span class="nb">export </span><span class="nv">bugly_appkey</span><span class="o">=</span><span class="s2">"bugly_appkey"</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>通知设置</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="c">#通知相关的设置（pgy渠道及apikey）</span>
<span class="k">function </span>notificationSettings<span class="o">()</span>
<span class="o">{</span>
    <span class="nv">notificationSettings</span><span class="o">=</span><span class="nv">$1</span>
    <span class="k">if</span> <span class="o">[</span> <span class="k">${</span><span class="nv">notificationSettings</span><span class="k">}</span> <span class="o">=</span> <span class="s2">"1"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">echo</span> <span class="s1">'///静默入参 不为空'</span>
        <span class="nb">export </span><span class="nv">notificationSilent</span><span class="o">=</span><span class="nv">$notificationSettings</span>
    <span class="k">else
        </span><span class="nb">echo</span> <span class="s1">'///静默入参 为空 或者不为1 不发通知'</span>
    <span class="k">fi
    
    </span><span class="nb">echo</span> <span class="s2">"////静默通知="</span><span class="k">${</span><span class="nv">notificationSilent</span><span class="k">}</span>
<span class="o">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>
    <p>参数获取:</p>

    <p>通过xcode工具获取工程项目自带的参数</p>
  </li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
</pre></td><td class="rouge-code"><pre><span class="c">#获取工程配置信息</span>
<span class="k">function </span>initInfoPlistParms<span class="o">()</span>
<span class="o">{</span>
    <span class="c">#Plist先写死。后续可考虑改成搜索</span>
    <span class="nb">cd</span> <span class="k">${</span><span class="nv">CurDir</span><span class="k">}</span>/<span class="k">${</span><span class="nv">projectDir</span><span class="k">}</span>
    <span class="nv">versionKey</span><span class="o">=</span><span class="s2">"MARKETING_VERSION"</span>
    <span class="nv">bundleID</span><span class="o">=</span><span class="s2">"PRODUCT_BUNDLE_IDENTIFIER"</span>
    <span class="nv">bundleNo</span><span class="o">=</span><span class="s2">"CURRENT_PROJECT_VERSION"</span>
    <span class="nv">platformName</span><span class="o">=</span><span class="s2">"PLATFORM_NAME"</span>
    <span class="nv">productName</span><span class="o">=</span><span class="s2">"PRODUCT_NAME"</span>
    <span class="c">#将要获取的key设置成数组</span>
    <span class="nv">buildSettingsGrepKeyArray</span><span class="o">=(</span><span class="nv">$versionKey</span> <span class="nv">$bundleID</span> <span class="nv">$bundleNo</span> <span class="nv">$platformName</span> <span class="nv">$productName</span><span class="o">)</span>
    <span class="nv">buildSettingsGrepKey</span><span class="o">=</span><span class="s2">""</span>
    <span class="k">for</span><span class="o">((</span> <span class="nv">i</span><span class="o">=</span>0<span class="p">;</span>i&lt;<span class="k">${#</span><span class="nv">buildSettingsGrepKeyArray</span><span class="p">[@]</span><span class="k">}</span><span class="p">;</span>i++<span class="o">))</span>
    <span class="k">do
        </span><span class="nb">echo</span> <span class="s2">"【获取Plist参数】遍历 idx="</span><span class="nv">$i</span> <span class="s2">"value="</span> <span class="k">${</span><span class="nv">buildSettingsGrepKeyArray</span><span class="p">[i]</span><span class="k">}</span>
        <span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$buildSettingsGrepKey</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
            </span><span class="nv">buildSettingsGrepKey</span><span class="o">=</span><span class="k">${</span><span class="nv">buildSettingsGrepKeyArray</span><span class="p">[i]</span><span class="k">}</span><span class="p">;</span>
        <span class="k">else
            </span>buildSettingsGrepKey+<span class="o">=</span><span class="s2">"</span><span class="se">\|</span><span class="s2">"</span><span class="k">${</span><span class="nv">buildSettingsGrepKeyArray</span><span class="p">[i]</span><span class="k">}</span><span class="p">;</span>
        <span class="k">fi
    done</span><span class="p">;</span>
    <span class="c">#将数组拼接成 grep 参数</span>
    <span class="nb">echo</span> <span class="s2">"【获取Plist参数】key："</span><span class="nv">$buildSettingsGrepKey</span>

    <span class="c">#-w 防止模糊匹配 比如  PRODUCT_NAME 和 FULL_PRODUCT_NAME</span>
    <span class="nv">buildSettings</span><span class="o">=</span><span class="sb">`</span>xcodebuild <span class="nt">-showBuildSettings</span> <span class="nt">-target</span> <span class="k">${</span><span class="nv">TARGET_NAME</span><span class="k">}</span> | <span class="nb">grep</span> <span class="nt">-w</span> <span class="nv">$buildSettingsGrepKey</span><span class="sb">`</span>
    <span class="nb">echo</span> <span class="s2">"【获取Plist参数】result："</span><span class="nv">$buildSettings</span>
    
    <span class="c">#取值数组</span>
    <span class="nv">buildSettingsGrepValueArray</span><span class="o">=[]</span>
    <span class="k">for</span><span class="o">((</span> <span class="nv">i</span><span class="o">=</span>0<span class="p">;</span>i&lt;<span class="k">${#</span><span class="nv">buildSettingsGrepKeyArray</span><span class="p">[@]</span><span class="k">}</span><span class="p">;</span>i++<span class="o">))</span>
    <span class="k">do</span>
        <span class="c">#右截断</span>
        <span class="nv">value</span><span class="o">=</span><span class="k">${</span><span class="nv">buildSettings</span><span class="p">#*</span><span class="k">${</span><span class="nv">buildSettingsGrepKeyArray</span><span class="p">[i]</span><span class="k">}</span><span class="p"> = </span><span class="k">}</span>
        <span class="k">for</span><span class="o">((</span> <span class="nv">j</span><span class="o">=</span>0<span class="p">;</span>j&lt;<span class="k">${#</span><span class="nv">buildSettingsGrepKeyArray</span><span class="p">[@]</span><span class="k">}</span><span class="p">;</span>j++<span class="o">))</span>
        <span class="k">do</span>
            <span class="c">#由于grep顺序不保证，遍历所有key进行右截断</span>
            <span class="nv">value</span><span class="o">=</span><span class="k">${</span><span class="nv">value</span><span class="p">%</span><span class="k">${</span><span class="nv">buildSettingsGrepKeyArray</span><span class="p">[j]</span><span class="k">}</span><span class="p">*</span><span class="k">}</span>
        <span class="k">done</span><span class="p">;</span>
        <span class="nv">value</span><span class="o">=</span><span class="sb">`</span><span class="nb">echo</span> <span class="k">${</span><span class="nv">value</span><span class="k">}</span> | <span class="nb">sed</span> <span class="s1">'s/\ //g'</span><span class="sb">`</span>
        <span class="nb">echo</span> <span class="s2">"【获取Plist参数】i="</span><span class="nv">$i</span> <span class="s2">"value="</span><span class="nv">$value</span><span class="s2">"。"</span>
        <span class="c">#填回取值数组</span>
        buildSettingsGrepValueArray[i]<span class="o">=</span><span class="k">${</span><span class="nv">value</span><span class="k">}</span>
    <span class="k">done</span><span class="p">;</span>
    
    <span class="c">#定义全部变量</span>
    <span class="nb">export </span><span class="nv">xcodeVersion3number</span><span class="o">=</span><span class="k">${</span><span class="nv">buildSettingsGrepValueArray</span><span class="p">[0]</span><span class="k">}</span>
    <span class="nb">echo</span> <span class="s2">"【获取Plist参数】版本号："</span><span class="nv">$xcodeVersion3number</span><span class="s2">"。"</span>

    <span class="nb">export </span><span class="nv">xcodeBundleID</span><span class="o">=</span><span class="k">${</span><span class="nv">buildSettingsGrepValueArray</span><span class="p">[1]</span><span class="k">}</span>
    <span class="nb">echo</span> <span class="s2">"【获取Plist参数】包名："</span><span class="nv">$xcodeBundleID</span><span class="s2">"。"</span>

    <span class="nb">export </span><span class="nv">xcodebundleNo</span><span class="o">=</span><span class="k">${</span><span class="nv">buildSettingsGrepValueArray</span><span class="p">[2]</span><span class="k">}</span>
    <span class="nb">echo</span> <span class="s2">"【获取Plist参数】build号："</span><span class="nv">$xcodebundleNo</span><span class="s2">"。"</span>
    
    <span class="nb">export </span><span class="nv">xcodePlatformName</span><span class="o">=</span><span class="k">${</span><span class="nv">buildSettingsGrepValueArray</span><span class="p">[3]</span><span class="k">}</span>
    <span class="nb">echo</span> <span class="s2">"【获取Plist参数】PlatformName："</span><span class="nv">$xcodePlatformName</span><span class="s2">"。"</span>
    
    <span class="nb">export </span><span class="nv">xcodeProductName</span><span class="o">=</span><span class="k">${</span><span class="nv">buildSettingsGrepValueArray</span><span class="p">[4]</span><span class="k">}</span>
    <span class="nb">echo</span> <span class="s2">"【获取Plist参数】ProductName："</span><span class="nv">$xcodeProductName</span><span class="s2">"。"</span>
    <span class="nb">cd</span> ..
<span class="o">}</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>构建号设置：</li>
</ul>

<p>​	设置构建号，可以避免每次构建的build重复，导致在appstore后台管理构建时的紊乱，也便于追溯构建代码版本等，而如果可以通过自动化的方式进行构建号的设置就更好了，这里提供一种设置思路：获取当前日期+流水线构建号(自增)，可以构建流水线内保证全局唯一：</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre></td><td class="rouge-code"><pre><span class="c">#自动(自增)修改构建号</span>
<span class="k">function </span>modify_build_no<span class="o">()</span>
<span class="o">{</span>
    <span class="nb">cd</span> <span class="k">${</span><span class="nv">CurDir</span><span class="k">}</span>/<span class="k">${</span><span class="nv">projectDir</span><span class="k">}</span>
    <span class="nb">export </span><span class="nv">BuildNo</span><span class="o">=</span><span class="sb">`</span><span class="nb">date</span> +%Y%m%d<span class="sb">`</span>
    <span class="c">#BuildNo，可以采用拼接日期+构建方式+流水线自增号来识别构建包的来源（构建方式：dailybuild、TestFlight、Release、TFInner）</span>
    <span class="nv">BuildNo</span><span class="o">=</span><span class="k">${</span><span class="nv">BuildNo</span><span class="k">}</span>.<span class="nv">$1</span>.<span class="k">${</span><span class="nv">SYS_PIPELINE_BUILD_NUMBER</span><span class="k">}</span>
<span class="c">#    plist_path=${CurDir}/${projectDir}/${projectDir}/Info.plist</span>
    <span class="nb">echo</span> <span class="s2">"【获取Plist参数】路径："</span><span class="nv">$plist_path</span>
    <span class="nb">echo</span> <span class="s2">"【设置Plist参数】build："</span><span class="nv">$BuildNo</span>    
<span class="c">#    /usr/libexec/PlistBuddy -c "Set :CFBundleVersion ${BuildNo}" ${plist_path}</span>
    agvtool new-version <span class="nt">-all</span> <span class="k">${</span><span class="nv">BuildNo</span><span class="k">}</span>
    <span class="nb">cd</span> -
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<h4 id="222-构建中">2.2.2 构建中：</h4>

<ul>
  <li>
    <p>执行构建：</p>

    <p>在完成了所有必要的构建前的设置之后，可以进行构建流程：</p>
  </li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="rouge-code"><pre><span class="c">#执行构建</span>
<span class="k">function </span>build<span class="o">()</span>
<span class="o">{</span>
    <span class="k">if</span> <span class="o">[</span> <span class="nt">-z</span> <span class="s2">"</span><span class="nv">$1</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">echo</span> <span class="s2">"error: configurationName 不能为空 退出"</span>
        <span class="nb">exit </span>1
    <span class="k">fi</span>
    <span class="c">#定义项目前缀,生成文件时使用</span>
    <span class="nb">export </span><span class="nv">PrefixID</span><span class="o">=</span>PSC_

    <span class="c">#设置根目录</span>
    <span class="nb">export </span><span class="nv">CurDir</span><span class="o">=</span><span class="sb">`</span><span class="nb">pwd</span><span class="sb">`</span>
    
    <span class="c">#进行打包的schemeName</span>
    <span class="nb">export </span><span class="nv">schemeName</span><span class="o">=</span>dailybuildipa
    
    <span class="c">#指定编译 配置 configuration</span>
    <span class="nv">configurationNameArray</span><span class="o">=(</span>DailyBuild TestFlight Release TFInner<span class="o">)</span>
    <span class="nb">export </span><span class="nv">configurationName</span><span class="o">=</span><span class="k">${</span><span class="nv">configurationNameArray</span><span class="p">[</span><span class="nv">$1</span><span class="p">]</span><span class="k">}</span>

    <span class="c">#指定编译脚本路径</span>
    <span class="c">#TODO: 这里需要匹配下当前脚本所在的目录</span>
    <span class="nb">export </span><span class="nv">buildsh_dir</span><span class="o">=</span><span class="k">${</span><span class="nv">CurDir</span><span class="k">}</span>/PSC_iOS_Build_SH

    <span class="c">#设置plist参数</span>
    modify_build_no <span class="nv">$1</span>

    <span class="c">#读取plist参数</span>
    initInfoPlistParms
    
    <span class="c">#执行构建</span>
    bash <span class="nv">$buildsh_dir</span>/build_sh.sh
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>构建流程设计包括：</p>

<ul>
  <li>设置环境变量</li>
  <li>
    <p>设置内部变量</p>
  </li>
  <li>
    <p>初始化环境</p>
  </li>
  <li>
    <p>mPaas设置（可选）</p>
  </li>
  <li>
    <p>执行pod</p>
  </li>
  <li>
    <p>构建工具适配（可选）</p>
  </li>
  <li>执行构建</li>
</ul>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre></td><td class="rouge-code"><pre><span class="k">function </span>build<span class="o">()</span>
<span class="o">{</span>
    <span class="c">#设置内部环境变量</span>
    initDevopsEnv
 
    <span class="c">#设置内部环境变量</span>
    createInternalEnv
        
    <span class="c">#初始化环境</span>
    init_env

    <span class="c">#执行pod之前，先配置mPaas在当前环境下的配置文件</span>
    mPaaSConfigSet
    
    <span class="c">#执行pod</span>
    pod_install

    <span class="c">#fix xcode 14.3 cocoapods bug</span>
    fiXCode143

    <span class="c">#执行构建</span>
    buildProject

    <span class="c">#执行构建归档操作</span>
    collection
    
    <span class="c">#上传（发布）安装包，供下载安装</span>
    bash <span class="nv">$buildsh_dir</span>/<span class="nv">$build_ext_fold</span>/<span class="nv">$publish_sh</span>

    <span class="k">if</span> <span class="o">[</span> <span class="k">${</span><span class="nv">configurationName</span><span class="k">}</span> <span class="o">=</span> <span class="s2">"DailyBuild"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
        <span class="c">#通知</span>
        bash <span class="nv">$buildsh_dir</span>/<span class="nv">$build_ext_fold</span>/<span class="nv">$notification_sh</span>
    <span class="k">fi</span>
<span class="o">}</span>
</pre></td></tr></tbody></table></code></pre></div></div>

<p>​	构建具体的思路可以参考源码，这里不再赘述</p>

<h4 id="223-构建后">2.2.3 构建后：</h4>

<ul>
  <li>归档</li>
</ul>

<p>为什么要归档：</p>

<p>归档主要是为了对构建的安装包IPA及dSYM进行一一对应，由于dailybuild都是在团队内分发，因此这边考虑只有在testflight及appstore时才进行归档。</p>

<p>此外；如果使用bugly进行崩溃收集，bugly已经不支持手动传dSYM，需要在构建时一并实现。</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
</pre></td><td class="rouge-code"><pre><span class="k">function </span>upload_dSYM<span class="o">()</span>
<span class="o">{</span>
		<span class="c">#这里可以根据各自情况，存在dSYM文件</span>
<span class="o">}</span>

<span class="k">function </span>upload_dSYM_to_bugly<span class="o">()</span>
<span class="o">{</span>
    <span class="nb">export </span><span class="nv">p</span><span class="o">=</span><span class="k">${</span><span class="nv">dSYM_dict_PATH</span><span class="k">}</span>
    
    <span class="c">#根据不同的应用进行设置</span>
    <span class="k">if</span> <span class="o">[</span> <span class="k">${</span><span class="nv">TARGET_NAME</span><span class="k">}</span> <span class="o">=</span> <span class="s2">"PSCiOS"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nv">bugly_appid</span><span class="o">=</span>xxx
        <span class="nv">bugly_appkey</span><span class="o">=</span>yyy
    <span class="k">fi
    
    </span><span class="nb">echo</span> <span class="s1">'/// 上传 dsym bugly '</span><span class="k">${</span><span class="nv">v</span><span class="k">}</span><span class="s1">'pkgName='</span><span class="k">${</span><span class="nv">pkgName</span><span class="k">}</span>
    
    <span class="c">#切换java 版本</span>
    java <span class="nt">-version</span>
    jdk8
    java <span class="nt">-version</span>
    
    <span class="nv">bugly_jar_path</span><span class="o">=</span><span class="nv">$buildsh_dir</span>/<span class="nv">$build_ext_fold</span>/collection_res/buglyqq-upload-symbol/buglyqq-upload-symbol.jar
    
    java <span class="nt">-jar</span> <span class="k">${</span><span class="nv">bugly_jar_path</span><span class="k">}</span> <span class="nt">-appid</span> <span class="k">${</span><span class="nv">bugly_appid</span><span class="k">}</span> <span class="nt">-appkey</span> <span class="k">${</span><span class="nv">bugly_appkey</span><span class="k">}</span> <span class="nt">-bundleid</span> <span class="k">${</span><span class="nv">pkgName</span><span class="k">}</span> <span class="nt">-version</span> <span class="k">${</span><span class="nv">v</span><span class="k">}</span> <span class="nt">-platform</span> IOS <span class="nt">-inputSymbol</span> <span class="k">${</span><span class="nv">p</span><span class="k">}</span>
<span class="o">}</span>

<span class="k">function </span>collection<span class="o">()</span>
<span class="o">{</span>
    <span class="nb">export </span><span class="nv">v</span><span class="o">=</span><span class="k">${</span><span class="nv">xcodeVersion3number</span><span class="k">}</span>.<span class="k">${</span><span class="nv">BuildNo</span><span class="k">}</span>
    <span class="nb">export </span><span class="nv">pkgName</span><span class="o">=</span><span class="k">${</span><span class="nv">xcodeBundleID</span><span class="k">}</span>

    <span class="c">#上传到bugly符号表</span>
    upload_dSYM_to_bugly

    <span class="c">#上传dSYM</span>
    upload_dSYM
<span class="o">}</span>

<span class="c">#归档</span>
collection

</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>发布</li>
</ul>

<p>归档后，对安装包进行分发，分发也分dailybuild与release：</p>

<p>dailybuild:目前采用发布到蒲公英渠道：<a href="#2.1.3">2.1.3 参数3(可选)：渠道号</a></p>

<p>Release:发布到AppStore</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="rouge-code"><pre>    <span class="k">if</span> <span class="o">[</span> <span class="k">${</span><span class="nv">configurationName</span><span class="k">}</span> <span class="o">=</span> <span class="s2">"Release"</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> <span class="k">${</span><span class="nv">configurationName</span><span class="k">}</span> <span class="o">=</span> <span class="s2">"TestFlight"</span> <span class="o">]</span> <span class="o">||</span> <span class="o">[</span> <span class="k">${</span><span class="nv">configurationName</span><span class="k">}</span> <span class="o">=</span> <span class="s2">"TFInner"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then</span>
           <span class="c">#TFInner 、TestFlight &amp; appstore 上传到appstore</span>
        <span class="nb">echo</span> <span class="s1">'/// 上传App Store 开始'</span>
        xcrun altool <span class="nt">--validate-app</span> <span class="nt">-f</span>  <span class="nv">$IPA_PATH</span> <span class="nt">--type</span>  ios  <span class="nt">--apiKey</span> <span class="nv">$appStore_apikey</span> <span class="nt">--apiIssuer</span> <span class="nv">$appStore_apiIssuer</span>
        xcrun altool <span class="nt">--upload-app</span> <span class="nt">-f</span>  <span class="nv">$IPA_PATH</span> <span class="nt">--type</span>  ios  <span class="nt">--apiKey</span> <span class="nv">$appStore_apikey</span> <span class="nt">--apiIssuer</span> <span class="nv">$appStore_apiIssuer</span>
        <span class="nb">echo</span> <span class="s1">'/// 上传App Store 结束'</span>
		<span class="k">fi</span>

</pre></td></tr></tbody></table></code></pre></div></div>

<ul>
  <li>通知</li>
</ul>

<p>通知可以有很多种方式，由于笔者团队使用钉钉，所以这里举个钉钉机器人例子：<a href="#2.1.4">2.1.4 参数4(可选)：是否静默通知</a></p>



                <hr style="visibility: hidden;">
                <ul class="pager">
                    
                    <li class="previous">
                        <a href="/2023/08/03/iOS-%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%9C%A8%E5%86%85%E7%BD%91%E8%81%94%E8%B0%83%E6%97%B6%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/" data-toggle="tooltip" data-placement="top" title="iOS客户端在内网联调时的解决方案">
                        Previous<br>
                        <span>iOS客户端在内网联调时的解决方案</span>
                        </a>
                    </li>
                    
                    
                    <li class="next">
                        <a href="/2023/08/11/Apple%E4%BC%81%E4%B8%9A%E8%B4%A6%E5%8F%B7%E6%B3%A8%E5%86%8C%E6%B5%81%E7%A8%8B/" data-toggle="tooltip" data-placement="top" title="Apple 企业账号注册流程">
                        Next<br>
                        <span>Apple 企业账号注册流程</span>
                        </a>
                    </li>
                    
                </ul>
                <hr style="visibility: hidden;">

                
                <!-- disqus 评论框 start -->
                <div class="comment">
                    <div id="disqus_thread" class="disqus-thread"></div>
                </div>
                <!-- disqus 评论框 end -->
                

                
            </div>  

    <!-- Side Catalog Container -->
        
            <div class="
                col-lg-2 col-lg-offset-0
                visible-lg-block
                sidebar-container
                catalog-container">
                <div class="side-catalog">
                    <hr class="hidden-sm hidden-xs">
                    <h5>
                        <a class="catalog-toggle" href="#">CATALOG</a>
                    </h5>
                    <ul class="catalog-body"></ul>
                </div>
            </div>
        

    <!-- Sidebar Container -->
            <div class="
                col-lg-8 col-lg-offset-2
                col-md-10 col-md-offset-1
                sidebar-container">

                <!-- Featured Tags -->
                


<section>
    
        <hr class="hidden-sm hidden-xs">
    
    <h5><a href="/archive/">FEATURED TAGS</a></h5>
    <div class="tags">
        
        
        
        
        
    </div>
</section>


                <!-- Friends Blog -->
                
            </div>
        </div>
    </div>
</article>

<!-- add support for mathjax by voleking-->






<!-- disqus 公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES * * */
    var disqus_shortname = "Cyp";
    var disqus_identifier = "/2023/08/08/iOS-话外篇-构建详解";
    var disqus_url = "http://localhost:4000/2023/08/08/iOS-%E8%AF%9D%E5%A4%96%E7%AF%87-%E6%9E%84%E5%BB%BA%E8%AF%A6%E8%A7%A3/";

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<!-- disqus 公共JS代码 end -->




<!-- async load function -->
<script>
    function async(u, c) {
      var d = document, t = 'script',
          o = d.createElement(t),
          s = d.getElementsByTagName(t)[0];
      o.src = u;
      if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
      s.parentNode.insertBefore(o, s);
    }
</script>
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/anchor-js/1.1.1/anchor.min.js",function(){
        anchors.options = {
          visible: 'hover',
          placement: 'right',
          // icon: '#'
        };
        anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
    })
</script>
<style>
    /* place left on bigger screen */
    @media all and (min-width: 800px) {
        .anchorjs-link{
            position: absolute;
            left: -0.75em;
            font-size: 1.1em;
            margin-top : -0.1em;
        }
    }
</style>



    <!-- Footer -->
<footer>
    <div class="container">
        <div class="row">
            <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
                <!-- SNS Link -->
                


<ul class="list-inline text-center">


  
  
  
  
  
  
  
</ul>

                <p class="copyright text-muted">
                    Copyright &copy; PaysonChen Blog 2024
                    <br>
                    <!-- Powered by <a href="http://huangxuan.me">Hux Blog</a> | -->
                 <!--    <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="100px"
                        height="20px"
                        src="https://ghbtns.com/github-btn.html?user=huxpro&repo=huxpro.github.io&type=star&count=true">
                    </iframe> -->
                </p>
            </div>
        </div>
    </div>
</footer>

<!-- jQuery -->
<script src="/js/jquery.min.js "></script>

<!-- Bootstrap Core JavaScript -->
<!-- Currently, only navbar scroll-down effect at desktop still depends on this -->
<script src="/js/bootstrap.min.js "></script>

<!-- Custom Theme JavaScript -->
<script src="/js/hux-blog.min.js "></script>

<!-- Simple Jekyll Search -->
<script src="/js/simple-jekyll-search.min.js"></script>

<!-- Service Worker -->

<script src="/js/snackbar.js "></script>
<script src="/js/sw-registration.js "></script>


<!-- async load function -->
<script>
    function async(u, c) {
        var d = document, t = 'script',
            o = d.createElement(t),
            s = d.getElementsByTagName(t)[0];
        o.src = u;
        if (c) { o.addEventListener('load', function (e) { c(null, e); }, false); }
        s.parentNode.insertBefore(o, s);
    }
</script>

<!--
     Because of the native support for backtick-style fenced code blocks
     right within the Markdown is landed in Github Pages,
     From V1.6, There is no need for Highlight.js,
     so Huxblog drops it officially.

     - https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0
     - https://help.github.com/articles/creating-and-highlighting-code-blocks/
     - https://github.com/jneen/rouge/wiki/list-of-supported-languages-and-lexers
-->
<!--
    <script>
        async("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function(){
            hljs.initHighlightingOnLoad();
        })
    </script>
    <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet">
-->







<!--fastClick.js -->
<script>
    async("//cdnjs.cloudflare.com/ajax/libs/fastclick/1.0.6/fastclick.min.js", function () {
        var $nav = document.querySelector("nav");
        if ($nav) FastClick.attach($nav);
    })
</script>


<!-- Google Analytics -->



<!-- Baidu Tongji -->



<!-- Side Catalog -->

<script type="text/javascript">
    function generateCatalog(selector) {

        // interop with multilangual 
        if ('' == 'true') {
            _containerSelector = 'div.post-container.active'
        } else {
            _containerSelector = 'div.post-container'
        }

        // init
        var P = $(_containerSelector), a, n, t, l, i, c;
        a = P.find('h1,h2,h3,h4,h5,h6');

        // clean
        $(selector).html('')

        // appending
        a.each(function () {
            n = $(this).prop('tagName').toLowerCase();
            i = "#" + $(this).prop('id');
            t = $(this).text();
            c = $('<a href="' + i + '" rel="nofollow">' + t + '</a>');
            l = $('<li class="' + n + '_nav"></li>').append(c);
            $(selector).append(l);
        });
        return true;
    }

    generateCatalog(".catalog-body");

    // toggle side catalog
    $(".catalog-toggle").click((function (e) {
        e.preventDefault();
        $('.side-catalog').toggleClass("fold")
    }))

    /*
     * Doc: https://github.com/davist11/jQuery-One-Page-Nav
     * Fork by Hux to support padding
     */
    async("/js/jquery.nav.js", function () {
        $('.catalog-body').onePageNav({
            currentClass: "active",
            changeHash: !1,
            easing: "swing",
            filter: "",
            scrollSpeed: 700,
            scrollOffset: 0,
            scrollThreshold: .2,
            begin: null,
            end: null,
            scrollChange: null,
            padding: 80
        });
    });
</script>



<!-- Multi-Lingual -->


<!-- Simple Jekyll Search -->
<script>
    // https://stackoverflow.com/questions/1912501/unescape-html-entities-in-javascript
    function htmlDecode(input) {
        var e = document.createElement('textarea');
        e.innerHTML = input;
        // handle case of empty input
        return e.childNodes.length === 0 ? "" : e.childNodes[0].nodeValue;
    }

    SimpleJekyllSearch({
        searchInput: document.getElementById('search-input'),
        resultsContainer: document.getElementById('search-results'),
        json: '/search.json',
        searchResultTemplate: '<div class="post-preview item"><a href="{url}"><h2 class="post-title">{title}</h2><h3 class="post-subtitle">{subtitle}</h3><hr></a></div>',
        noResultsText: 'No results',
        limit: 50,
        fuzzy: false,
        // a hack to get escaped subtitle unescaped. for some reason, 
        // post.subtitle w/o escape filter nuke entire search.
        templateMiddleware: function (prop, value, template) {
            if (prop === 'subtitle' || prop === 'title') {
                if (value.indexOf("code")) {
                    return htmlDecode(value);
                } else {
                    return value;
                }
            }
        }
    });

    $(document).ready(function () {
        var $searchPage = $('.search-page');
        var $searchOpen = $('.search-icon');
        var $searchClose = $('.search-icon-close');
        var $searchInput = $('#search-input');
        var $body = $('body');

        $searchOpen.on('click', function (e) {
            e.preventDefault();
            $searchPage.toggleClass('search-active');
            var prevClasses = $body.attr('class') || '';
            setTimeout(function () {
                $body.addClass('no-scroll');
            }, 400)

            if ($searchPage.hasClass('search-active')) {
                $searchClose.on('click', function (e) {
                    e.preventDefault();
                    $searchPage.removeClass('search-active');
                    $body.attr('class', prevClasses);  // from closure 
                });
                $searchInput.focus();
            }
        });
    });
</script>


<!-- Image to hack wechat -->
<img src="/img/icon_wechat.png" width="0" height="0" />
<!-- Migrate from head to bottom, no longer block render and still work -->

</body>

</html>
